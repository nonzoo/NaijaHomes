{% extends 'Properties/base.html' %}
{% load number_format %}
{% block content %}

<section class="max-w-6xl mx-auto">

    <!-- Breadcrumb -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="breadcrumb">
                <a href="{% url 'frontpage' %}">Home</a>
                <span>/</span>
                <a href="{% url 'property_list' %}">Properties</a>
                <span>/</span>
                <span class="text-gray-900 font-medium">Property Details</span>
            </div>
        </div>
    </div>

    <!-- Gallery Section -->
    <div class="mb-8 animate-slide-in relative">

        <div class="gallery-grid">

            {# MAIN IMAGE index = 0 #}
            {% if property.image %}
            <div class="relative">
                <img src="{{ property.image.url }}" alt="Main property image" class="gallery-img"
                    onclick="openCarousel(0)">
            </div>
            {% endif %}

            {# EXTRA IMAGES #}
            {% if property.image %}
            {# main image exists, so extra images start at index 1 in the carousel #}
            {% for img in property.images.all|slice:":4" %}
            <div class="relative">
                <img src="{{ img.image.url }}" alt="Property image {{ forloop.counter }}"
                    class="gallery-img js-carousel" data-index="{{ forloop.counter0|add:'1' }}">

                {% if forloop.last and property.images.count > 4 %}
                <div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-lg font-bold cursor-pointer rounded-xl js-carousel"
                    data-index="{{ forloop.counter0|add:'1' }}">
                    +{{ property.images.count|add:"-4" }} More
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            {# no main image, so extra images start at index 0 in the carousel #}
            {% for img in property.images.all|slice:":5" %}
            <div class="relative">
                <img src="{{ img.image.url }}" alt="Property image {{ forloop.counter }}"
                    class="gallery-img js-carousel" data-index="{{ forloop.counter0 }}">

                {% if forloop.last and property.images.count > 5 %}
                <div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-lg font-bold cursor-pointer rounded-xl js-carousel"
                    data-index="{{ forloop.counter0 }}">
                    +{{ property.images.count|add:"-5" }} More
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% endif %}


        </div>

        {# Favorite button overlay #}
        {% if user.is_authenticated %}
        <button data-property-id="{{ property.id }}" class="favorite-btn absolute top-4 right-4 w-10 h-10 rounded-full flex items-center justify-center transition-colors z-10
            {% if property.id in favorite_ids %}
                bg-emerald-600
            {% else %}
                bg-white/90 hover:bg-white
            {% endif %}
            ">
            <svg class="w-5 h-5
                {% if property.id in favorite_ids %}
                    text-white fill-white
                {% else %}
                    text-gray-600
                {% endif %}
            " fill="{% if property.id in favorite_ids %}currentColor{% else %}none{% endif %}" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
        </button>
        {% else %}
        <a href="{% url 'auth' %}"
            class="absolute top-4 right-4 w-10 h-10 bg-white/90 rounded-full flex items-center justify-center z-10">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
        </a>
        {% endif %}

    </div>

    <!-- Image Modal / Carousel -->
    <div id="imageModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70">
        <div class="relative max-w-4xl w-full mx-4">

            <button id="closeCarousel"
                class="absolute top-4 right-4 w-10 h-10 bg-white rounded-full flex items-center justify-center hover:bg-gray-100 z-20">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <button id="prevBtn"
                class="absolute left-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full flex items-center justify-center hover:bg-gray-100 z-20">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>

            <div class="bg-white rounded-lg overflow-hidden">
                <img id="carouselImage" src="" alt="Full size property image"
                    class="w-full h-[70vh] object-contain bg-black">
            </div>

            <button id="nextBtn"
                class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-white rounded-full flex items-center justify-center hover:bg-gray-100 z-20">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>

            <div id="carouselCounter" class="text-center text-white mt-2"></div>
        </div>
    </div>

    <!-- Property Info Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Main Info -->
        <div class="lg:col-span-2">

            <div class="mb-8 animate-slide-in">
                <div class="flex items-start justify-between gap-4 mb-4">
                    <div>
                        <h1 id="property-title" class="font-display text-3xl sm:text-4xl font-bold text-gray-900 mb-2">
                            {{ property.title }}
                        </h1>
                        <p id="property-location" class="text-lg text-gray-600 flex items-center gap-2">
                            <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            {{ property.address }}
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-3 mb-6">
                    <span class="inline-block px-4 py-2 bg-emerald-600 text-white font-bold rounded-lg">
                        {{ property.property_type }}
                    </span>
                    {% if property.is_featured %}
                    <span class="inline-block px-4 py-2 bg-amber-500 text-white font-bold rounded-lg">
                        FEATURED
                    </span>
                    {% endif %}
                </div>

                <div class="text-4xl sm:text-5xl font-bold text-emerald-700 mb-2">
                    ₦{{ property.formatted_price }}
                </div>
            </div>

            <!-- Key Features -->
            <div class="mb-8">
                <h2 class="font-display text-2xl font-bold text-gray-900 mb-6">Key Features</h2>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">

                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-lg text-gray-900">{{ property.bedrooms }}</div>
                            <div class="text-sm text-gray-600">Bedrooms</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                            </svg>
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-lg text-gray-900">{{ property.bathrooms }}</div>
                            <div class="text-sm text-gray-600">Bathrooms</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">
                            <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-lg text-gray-900">{{ property.Sqm }}</div>
                            <div class="text-sm text-gray-600">Sqm</div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Description -->
            <div class="mb-8">
                <h2 class="font-display text-2xl font-bold text-gray-900 mb-4">About This Property</h2>
                <p id="property-description" class="text-gray-700 leading-relaxed text-lg mb-4">
                    {{ property.description }}
                </p>
            </div>

        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <div class="agent-card sticky top-24 animate-slide-in">
                {% if property.agent.profile_image %}
                <img src="{{ property.agent.profile_image.url }}" alt="Agent photo" class="agent-avatar"
                    onerror="this.style.background='#d4af37';">
                {% else %}
                <div
                    class="agent-avatar flex items-center justify-center bg-emerald-600 text-white font-display text-2xl">
                    {{ property.agent.username|slice:":1"|upper }}
                </div>
                {% endif %}

                <h3 id="agent-name" class="font-display text-2xl font-bold text-gray-900 mb-1">
                    {{ property.agent.first_name }} {{ property.agent.last_name }}
                </h3>

                <p class="text-emerald-600 font-semibold mb-4">Property Agent</p>

                <div class="bg-white rounded-lg p-4 mb-6 border border-gray-200">
                    <p class="text-sm text-gray-600 mb-2">Experience</p>
                    <p class="text-2xl font-bold text-emerald-700">{{ agent.experience }} Years</p>
                </div>

                <div class="bg-white rounded-lg p-4 mb-6 border border-gray-200">
                    <p class="text-sm text-gray-600 mb-2">Phone Number</p>
                    <p id="agent-phone" class="text-lg font-semibold text-gray-900">{{ property.agent.phone_number }}
                    </p>
                </div>

                <a href="tel:{{ property.agent.phone_number }}">
                    <button
                        class="btn-call w-full py-3 text-white font-bold rounded-lg mb-3 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" />
                        </svg>
                        Call Agent
                    </button>
                </a>

                <a href="mailto:{{ property.agent.email }}">
                    <button
                        class="w-full py-3 text-emerald-700 font-bold rounded-lg border-2 border-emerald-700 hover:bg-emerald-50 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        Send Message
                    </button>
                </a>
{% if agent.verified %}
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-xs text-gray-500 mb-3">Verified Agent</p>
                        <div class="flex items-center justify-center gap-2 text-emerald-600 font-semibold">
                            <svg class="w-5 h-5" fill="currentColor" viewbox="0 0 24 24">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg> Badge Verified
                        </div>
                    </div>
                    {% else %}
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <p class="text-xs text-gray-500 mb-3">Unverified Agent</p>
                        <div class="flex items-center justify-center gap-2 text-red-600 font-semibold">
                            <svg class="w-5 h-5" fill="currentColor" viewbox="0 0 24 24">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13l-1.41 1.41L12 13.41l-3.59 3.59L7 15l3.59-3.59L7.41 8.41 9 7l3.59 3.59L16.59 7 18 8.41l-3.59 3.59L18 15z" />
                            </svg> Not Verified
                            {% endif %}
                        </div>
                    </div>
            </div>

            <div id="toast"
                class="fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg hidden z-50"></div>
        </div>

    </div>
</section>

<!-- Related Properties -->
{% if similar_properties %}
<section class="py-12 sm:py-16 px-4 sm:px-6 lg:px-8 bg-white border-t border-gray-200">
    <div class="max-w-6xl mx-auto">
        <h2 class="font-display text-3xl font-bold text-gray-900 mb-8">Similar Properties</h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for similar in similar_properties %}
            <div class="bg-stone-50 rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition-all">
                <img src="{{ similar.image_url }}" alt="Similar property" class="w-full h-48 object-cover">
                <div class="p-4">
                    <h3 class="font-display text-lg font-bold text-gray-900 mb-2">{{ similar.title }}</h3>
                    <p class="text-gray-600 text-sm mb-3">{{ similar.address }}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-2xl font-bold text-emerald-700">₦{{ similar.price }}</span>
                        <a href="{% url 'property_detail' similar.id %}">
                            <button
                                class="px-3 py-1.5 bg-emerald-700 text-white font-semibold rounded-lg text-sm hover:bg-emerald-800">View</button>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<style>
    body {
        box-sizing: border-box;
    }

    .font-display {
        font-family: 'Playfair Display', serif;
    }

    .font-body {
        font-family: 'DM Sans', sans-serif;
    }

    .gallery-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        grid-template-rows: 300px 300px;
        gap: 8px;
    }

    @media (max-width: 768px) {
        .gallery-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto;
        }
    }

    .gallery-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }

    .gallery-img:hover {
        transform: scale(1.05);
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .feature-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #1a472a 0%, #2d5a3d 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .agent-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 24px;
        text-align: center;
    }

    .agent-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto 16px;
        border: 3px solid #d4af37;
    }

    .btn-call {
        background: linear-gradient(135deg, #047857 0%, #059669 100%);
        transition: all 0.3s ease;
    }

    .btn-call:hover {
        background: linear-gradient(135deg, #065f46 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(4, 120, 87, 0.3);
    }

    .breadcrumb {
        display: flex;
        gap: 8px;
        font-size: 14px;
        color: #6b7280;
    }

    .breadcrumb a {
        color: #047857;
        font-weight: 500;
        transition: color 0.3s;
    }

    .breadcrumb a:hover {
        color: #065f46;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in {
        animation: slideIn 0.6s ease-out;
    }
</style>

{{ images_list|json_script:"property-images" }}


<script>
    const images = JSON.parse(document.getElementById("property-images").textContent);

    const modal = document.getElementById('imageModal');
    const carouselImage = document.getElementById('carouselImage');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const closeBtn = document.getElementById('closeCarousel');
    const counter = document.getElementById('carouselCounter');
    let currentIndex = 0;

    function updateCarousel() {
        if (!images.length) return;
        carouselImage.src = images[currentIndex];
        counter.textContent = (currentIndex + 1) + ' / ' + images.length;
    }

    function openCarousel(index) {
        if (!images.length) return;
        currentIndex = Number(index) || 0;
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex >= images.length) currentIndex = images.length - 1;

        updateCarousel();

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.classList.add('overflow-hidden');
    }

    function closeCarousel() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.classList.remove('overflow-hidden');
    }

    prevBtn.addEventListener('click', function () {
        if (!images.length) return;
        currentIndex = (currentIndex - 1 + images.length) % images.length;
        updateCarousel();
    });

    nextBtn.addEventListener('click', function () {
        if (!images.length) return;
        currentIndex = (currentIndex + 1) % images.length;
        updateCarousel();
    });

    closeBtn.addEventListener('click', closeCarousel);

    modal.addEventListener('click', function (e) {
        if (e.target === modal) closeCarousel();
    });

    document.addEventListener('keydown', function (e) {
        if (modal.classList.contains('hidden')) return;
        if (e.key === 'ArrowLeft') prevBtn.click();
        if (e.key === 'ArrowRight') nextBtn.click();
        if (e.key === 'Escape') closeCarousel();
    });



    document.querySelectorAll(".js-carousel").forEach(el => {
        el.addEventListener("click", function () {
            openCarousel(this.dataset.index);
        });
    });


</script>

{% endblock %}